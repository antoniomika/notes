<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.32.13"/><title data-react-helmet="true">Roll you own ZFS NAS Â· A personal blog and note taking site</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" name="viewport" content="initial-scale=1.0, width=device-width"/><link as="script" rel="preload" href="/webpack-runtime-6c5d3617d53de854ad20.js"/><link as="script" rel="preload" href="/framework-643cd9d57cfac08fd2c4.js"/><link as="script" rel="preload" href="/1bfc9850-284bb63085f6cc17369b.js"/><link as="script" rel="preload" href="/app-c6ef5c2f96254335c1a0.js"/><link as="script" rel="preload" href="/commons-0b008caf945293618b83.js"/><link as="script" rel="preload" href="/component---src-gatsby-theme-code-notes-templates-note-js-b0f61fea6533f3ee3656.js"/><link as="fetch" rel="preload" href="/page-data/zfs-nas/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1322576299.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1437003973.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/467212769.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/467212769.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="1om1xv2">body{--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,hsl(210,38%,95%));--theme-ui-colors-background:var(--theme-ui-colors-background,hsl(285,5%,17%));--theme-ui-colors-scrollbar:var(--theme-ui-colors-scrollbar,hsl(285,5%,12%));--theme-ui-colors-backgroundTransparent:var(--theme-ui-colors-backgroundTransparent,hsla(285,5%,17%,0.72));--theme-ui-colors-contentBg:var(--theme-ui-colors-contentBg,#383539);--theme-ui-colors-primary:var(--theme-ui-colors-primary,hsl(345,100%,69%));--theme-ui-colors-primarySemiTransparent:var(--theme-ui-colors-primarySemiTransparent,hsl(345,100%,79%,0.5));--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#718096);--theme-ui-colors-muted:var(--theme-ui-colors-muted,hsl(210,5%,40%));--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-navHover:var(--theme-ui-colors-navHover,hsl(285,5%,13%));--theme-ui-colors-codeBackground:var(--theme-ui-colors-codeBackground,#2d2a2e);--theme-ui-colors-badgeBg:var(--theme-ui-colors-badgeBg,hsl(285,5%,17%));--theme-ui-colors-badgeBgHover:var(--theme-ui-colors-badgeBgHover,hsl(285,5%,20%));--theme-ui-colors-badgeBorder:var(--theme-ui-colors-badgeBorder,hsl(285,5%,12%));--theme-ui-colors-input:var(--theme-ui-colors-input,#ddd);--theme-ui-colors-code1:var(--theme-ui-colors-code1,hsl(345,100%,69%));--theme-ui-colors-code2:var(--theme-ui-colors-code2,#fc9867);--theme-ui-colors-code3:var(--theme-ui-colors-code3,#ffd866);--theme-ui-colors-code4:var(--theme-ui-colors-code4,#a9dc76);--theme-ui-colors-code5:var(--theme-ui-colors-code5,#78dce8);--theme-ui-colors-code6:var(--theme-ui-colors-code6,#ab9df2);--theme-ui-colors-code7:var(--theme-ui-colors-code7,#999988);color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,hsl(210,38%,95%));--theme-ui-colors-scrollbar:var(--theme-ui-colors-modes-dark-scrollbar,hsl(210,20%,85%));--theme-ui-colors-backgroundTransparent:var(--theme-ui-colors-modes-dark-backgroundTransparent,hsla(210,38%,95%,0.72));--theme-ui-colors-contentBg:var(--theme-ui-colors-modes-dark-contentBg,#f7fafc);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,hsl(334,86%,48%));--theme-ui-colors-primarySemiTransparent:var(--theme-ui-colors-modes-dark-primarySemiTransparent,hsla(334,86%,48%,0.5));--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#718096);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-modes-dark-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-modes-dark-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-modes-dark-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-modes-dark-danger,#feb2b2);--theme-ui-colors-navHover:var(--theme-ui-colors-modes-dark-navHover,#cbd5e0);--theme-ui-colors-codeBackground:var(--theme-ui-colors-modes-dark-codeBackground,#fbf2e9);--theme-ui-colors-badgeBg:var(--theme-ui-colors-modes-dark-badgeBg,hsl(210,25%,97%));--theme-ui-colors-badgeBgHover:var(--theme-ui-colors-modes-dark-badgeBgHover,hsl(210,25%,89%));--theme-ui-colors-badgeBorder:var(--theme-ui-colors-modes-dark-badgeBorder,hsl(207,24%,83%));--theme-ui-colors-input:var(--theme-ui-colors-modes-dark-input,#92A2B9);--theme-ui-colors-code1:var(--theme-ui-colors-modes-dark-code1,hsl(211,61%,23%));--theme-ui-colors-code2:var(--theme-ui-colors-modes-dark-code2,#fc9867);--theme-ui-colors-code3:var(--theme-ui-colors-modes-dark-code3,#e3116c);--theme-ui-colors-code4:var(--theme-ui-colors-modes-dark-code4,#d73a49);--theme-ui-colors-code5:var(--theme-ui-colors-modes-dark-code5,hsl(211,61%,43%));--theme-ui-colors-code6:var(--theme-ui-colors-modes-dark-code6,#6f42c1);--theme-ui-colors-code7:var(--theme-ui-colors-modes-dark-code7,#999988);}</style><style data-emotion-css="svsiph">*{box-sizing:border-box;}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.625;font-weight:400;font-size:1rem;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="yhthxk">*{box-sizing:border-box;}body{margin:0;}:root{font-size:16px;}@media (min-width:480px){:root{font-size:calc(1rem + ((1vw - 4.8px) * 0.2778));}}@media (min-width:1920px){:root{font-size:20px;}}</style><style data-emotion-css="1opvhak">.css-1opvhak{position:relative;top:0;right:0;bottom:0;left:0;overflow-x:hidden;overflow-y:auto;z-index:10;padding:2.5rem;background-color:var(--theme-ui-colors-contentBg,#383539);-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;box-shadow:0 0 6px -1px rgba(0,0,0,0.1),0 0 4px -1px rgba(0,0,0,0.06);border-radius:0;min-height:100vh;}@media screen and (min-width:40em){.css-1opvhak{position:fixed;top:1rem;right:1rem;bottom:1rem;left:240px;-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0);box-shadow:0 0 6px -1px rgba(0,0,0,0.1),0 0 4px -1px rgba(0,0,0,0.06);border-radius:0.25rem;min-height:unset;}}</style><style data-emotion-css="vvc0si">.css-vvc0si{box-sizing:border-box;margin:0;min-width:0;position:relative;top:0;right:0;bottom:0;left:0;overflow-x:hidden;overflow-y:auto;z-index:10;padding:2.5rem;background-color:var(--theme-ui-colors-contentBg,#383539);-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;box-shadow:0 0 6px -1px rgba(0,0,0,0.1),0 0 4px -1px rgba(0,0,0,0.06);border-radius:0;min-height:100vh;}@media screen and (min-width:40em){.css-vvc0si{position:fixed;top:1rem;right:1rem;bottom:1rem;left:240px;-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0);box-shadow:0 0 6px -1px rgba(0,0,0,0.1),0 0 4px -1px rgba(0,0,0,0.06);border-radius:0.25rem;min-height:unset;}}</style><main class="css-vvc0si"><style data-emotion-css="1qjd62t">.css-1qjd62t{margin-bottom:0.5rem;display:block;}@media screen and (min-width:40em){.css-1qjd62t{display:none;}}</style><style data-emotion-css="s7tziy">.css-s7tziy{box-sizing:border-box;margin:0;min-width:0;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:0.25rem;width:32px;height:32px;color:inherit;background-color:transparent;border:none;border-radius:4px;margin-bottom:0.5rem;display:block;}@media screen and (min-width:40em){.css-s7tziy{display:none;}}</style><button title="Menu" aria-label="Toggle Menu" class="css-s7tziy"><style data-emotion-css="ipc245">.css-ipc245{box-sizing:border-box;margin:0;min-width:0;display:block;margin:0;}</style><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentcolor" viewBox="0 0 24 24" class="css-ipc245"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button><style data-emotion-css="o44is">.css-o44is{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;}</style><style data-emotion-css="15c8zhg">.css-15c8zhg{box-sizing:border-box;margin:0;min-width:0;width:100%;max-width:900px;margin-left:auto;margin-right:auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;}</style><div class="css-15c8zhg"><style data-emotion-css="8fkoyy">.css-8fkoyy{margin-bottom:2rem;}</style><style data-emotion-css="193v69v">.css-193v69v{box-sizing:border-box;margin:0;min-width:0;margin-bottom:2rem;}</style><div class="css-193v69v"><style data-emotion-css="79elbk">.css-79elbk{position:relative;}</style><style data-emotion-css="15owl46">.css-15owl46{box-sizing:border-box;margin:0;min-width:0;position:relative;}</style><div class="css-15owl46"><style data-emotion-css="sktxvt">.css-sktxvt{position:absolute;top:50%;left:0.5rem;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);color:var(--theme-ui-colors-input,#ddd);pointer-events:none;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="css-sktxvt" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15.7 13.3l-3.81-3.83A5.93 5.93 0 0 0 13 6c0-3.31-2.69-6-6-6S1 2.69 1 6s2.69 6 6 6c1.3 0 2.48-.41 3.47-1.11l3.83 3.81c.19.2.45.3.7.3.25 0 .52-.09.7-.3a.996.996 0 0 0 0-1.41v.01zM7 10.7c-2.59 0-4.7-2.11-4.7-4.7 0-2.59 2.11-4.7 4.7-4.7 2.59 0 4.7 2.11 4.7 4.7 0 2.59-2.11 4.7-4.7 4.7z"></path></svg><style data-emotion-css="13ck39u">.css-13ck39u{box-sizing:border-box;margin:0;min-width:0;display:block;width:100%;padding:0.5rem;-webkit-appearance:none;-moz-appearance:none;appearance:none;font-size:inherit;line-height:inherit;border:1px solid;border-radius:4px;color:inherit;background-color:transparent;border:0;border-bottom:1px solid var(--theme-ui-colors-input,#ddd);padding-left:2rem;border-radius:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;}.css-13ck39u:focus{box-shadow:0 2px 0 var(--theme-ui-colors-primary,hsl(345,100%,69%));outline:none;border-color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><input value="" aria-label="Search" placeholder="Search notes" class="css-13ck39u"/></div></div><article><style data-emotion-css="1i385gf">.css-1i385gf{box-sizing:border-box;margin:0;min-width:0;margin-bottom:1.5rem;}</style><header class="css-1i385gf"><style data-emotion-css="kmbr3">.css-kmbr3{box-sizing:border-box;margin:0;min-width:0;font-family:inherit;font-weight:400;line-height:1.25;font-weight:700;font-size:3rem;margin-bottom:1rem;line-height:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><h1 class="css-kmbr3">Roll you own ZFS NAS</h1><style data-emotion-css="120nvbq">.css-120nvbq{box-sizing:border-box;margin:0;min-width:0;margin-bottom:1rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="css-120nvbq"></div><style data-emotion-css="4cffwv">.css-4cffwv{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="css-4cffwv"><style data-emotion-css="jma0kd">.css-jma0kd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><style data-emotion-css="1rvt7oz">.css-1rvt7oz{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="css-1rvt7oz"><style data-emotion-css="4ihca9">.css-4ihca9{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;margin-right:0.25rem;background-color:hsla(355,40%,60%,0.5);}</style><style data-emotion-css="xq0p9i">.css-xq0p9i{box-sizing:border-box;margin:0;min-width:0;border-radius:50px;color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-badgeBg,hsl(285,5%,17%));-webkit-text-decoration:none;text-decoration:none;padding-left:0.5rem;padding-right:0.5rem;font-weight:400;font-size:0.7rem;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;margin-right:0.25rem;background-color:hsla(355,40%,60%,0.5);}.css-xq0p9i:hover{-webkit-text-decoration:none;text-decoration:none;opacity:0.7;}</style><a class="css-xq0p9i" href="/tag/blog">blog</a></div></div></header><style data-emotion-css="1l92nzk">.css-1l92nzk{box-sizing:border-box;margin:0;min-width:0;margin-top:1.5rem;margin-bottom:1.5rem;}</style><details class="css-1l92nzk"><summary>Table of contents</summary><ul><li><style data-emotion-css="wts7qx">.css-wts7qx{box-sizing:border-box;margin:0;min-width:0;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;}.css-wts7qx:link,.css-wts7qx:visited{font-weight:700;color:var(--theme-ui-colors-text,hsl(210,38%,95%));-webkit-text-decoration:none;text-decoration:none;border-bottom:2px solid;border-bottom-color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}.css-wts7qx:hover,.css-wts7qx:focus{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><a href="#background" class="css-wts7qx">Background</a></li><li><a href="#its-as-easy-as-3-2-1" class="css-wts7qx">It&#x27;s as easy as 3-2-1</a></li><li><a href="#my-strategy" class="css-wts7qx">My strategy</a></li><li><a href="#technologies" class="css-wts7qx">Technologies</a></li><li><a href="#backup-setup" class="css-wts7qx">Backup Setup</a><ul><li><a href="#zfs-setup" class="css-wts7qx">ZFS Setup</a></li><li><a href="#software-setup" class="css-wts7qx">Software Setup</a></li></ul></li><li><a href="#replication-setup" class="css-wts7qx">Replication Setup</a><ul><li><a href="#zfs-snapshots" class="css-wts7qx">ZFS Snapshots</a></li><li><a href="#reconciliation" class="css-wts7qx">Reconciliation</a></li><li><a href="#automated-backups-with-send-and-receive" class="css-wts7qx">Automated backups with send and receive</a></li></ul></li><li><a href="#monitoring" class="css-wts7qx">Monitoring</a></li><li><a href="#networking" class="css-wts7qx">Networking</a></li><li><a href="#acknowledgements" class="css-wts7qx">Acknowledgements</a></li></ul></details><style data-emotion-css="1lkofo6">.css-1lkofo6{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:2.25rem;}</style><style data-emotion-css="1sv7zxb">.css-1sv7zxb{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:2.25rem;}.css-1sv7zxb:hover .slug{opacity:0.6;}</style><h2 id="background" class="css-1sv7zxb">Background<style data-emotion-css="zoqt8o">.css-zoqt8o{font-size:1.25rem;-webkit-text-decoration:none;text-decoration:none;padding-right:1rem;padding-left:1rem;display:inline-block;color:var(--theme-ui-colors-text,hsl(210,38%,95%));opacity:0.2;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;}.css-zoqt8o:hover,.css-zoqt8o:focus{opacity:1;color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><a class="slug css-zoqt8o" href="#background"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><style data-emotion-css="mfqae4">.css-mfqae4{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,hsl(210,38%,95%));margin-bottom:1.25rem;}</style><p class="css-mfqae4">Recently I&#x27;ve noticed an uptick in the engagement found within the self-hosting community,
so I&#x27;ve decided to start a series of posts that look into why and how I handle self-hosting.
Today&#x27;s post will focus on data storage and will look into some of the options available when
it comes to data backups.</p><p class="css-mfqae4">Data storage is hard. Data backup is even harder. Therefore, I spent some time recently
to re-evaluate my backup strategy. Prior to deciding to roll my own backup solution, I would generally
backup files to Google Drive as my main &quot;backup&quot; mechanism. This was quite a shameful setup but gave
me a good amount of storage with easy access to all of my data. I used the Enterprise Workspace plan
which gave me access to as much storage as I needed, but Google soon changed their offering. I was using
~9TB of storage at that time, so once they removed the &quot;as much as you need&quot; provision, I had to use 2 users
worth of pooled storage. This amounts to ~$40/mo, which is still not terrible for data storage that is
fairly reliable.</p><h2 id="its-as-easy-as-3-2-1" class="css-1sv7zxb">It&#x27;s as easy as 3-2-1<a class="slug css-zoqt8o" href="#its-as-easy-as-3-2-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">When architecting my new backup strategy, I decided it was time for an upgrade. Generally, the 3-2-1
data backup method is recommended. The idea with this strategy is you maintain <em class="css-0">3</em> different copies of
your data, with <em class="css-0">2</em> copies stored in two different locations/media, and <em class="css-0">1</em> copy stored at an offsite location.
This setup is pretty easy to achieve and provides pretty good fault-tolerance and disaster recovery.
It also ensures that your data is protected when the unthinkable happens.</p><style data-emotion-css="f8y5iy">.css-f8y5iy{padding:1rem;color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));border-radius:0.25rem;overflow-x:auto;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}</style><style data-emotion-css="1cyhw3">.css-1cyhw3{padding:1rem;padding-top:0.5rem;margin-top:0;font-size:0.875rem;color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));overflow-x:auto;border-radius:0 0 0.25rem 0.25rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}.css-1cyhw3 .comment,.css-1cyhw3 .prolog,.css-1cyhw3 .doctype,.css-1cyhw3 .cdata{color:var(--theme-ui-colors-code7,#999988);font-style:italic;}.css-1cyhw3 .namespace{opacity:0.7;}.css-1cyhw3 .string,.css-1cyhw3 .attr-value,.css-1cyhw3 .punctuation,.css-1cyhw3 .tag.script-punctuation,.css-1cyhw3 .tag.attr-value.punctuation{color:var(--theme-ui-colors-code3,#ffd866);}.css-1cyhw3 .entity,.css-1cyhw3 .url,.css-1cyhw3 .symbol,.css-1cyhw3 .number,.css-1cyhw3 .boolean,.css-1cyhw3 .constant,.css-1cyhw3 .property,.css-1cyhw3 .regex,.css-1cyhw3 .inserted,.css-1cyhw3 .attr-value,.css-1cyhw3 .tag.attr-value{color:var(--theme-ui-colors-text,hsl(210,38%,95%));}.css-1cyhw3 .function,.css-1cyhw3 .tag.function,.css-1cyhw3 .deleted,.css-1cyhw3 .variable,.css-1cyhw3 .unit{color:var(--theme-ui-colors-code3,#ffd866);}.css-1cyhw3 .function-variable{color:var(--theme-ui-colors-code6,#ab9df2);}.css-1cyhw3 .tag,.css-1cyhw3 .keyword,.css-1cyhw3 .selector,.css-1cyhw3 .attr-name,.css-1cyhw3 .tag.attr-name{color:var(--theme-ui-colors-code5,#78dce8);}.css-1cyhw3 .symbol,.css-1cyhw3 .tag.punctuation{color:var(--theme-ui-colors-code7,#999988);}.css-1cyhw3 .property,.css-1cyhw3 .number{color:var(--theme-ui-colors-code6,#ab9df2);}.css-1cyhw3 .rule,.css-1cyhw3 .class-name,.css-1cyhw3 .keyword.module,.css-1cyhw3 .operator,.css-1cyhw3 .tag{color:var(--theme-ui-colors-code1,hsl(345,100%,69%));}.css-1cyhw3 .function,.css-1cyhw3 .tag.function{color:var(--theme-ui-colors-code4,#a9dc76);}.css-1cyhw3::-webkit-scrollbar{width:0.5rem;height:0.5rem;}.css-1cyhw3::-webkit-scrollbar:hover{width:1rem;height:1rem;}.css-1cyhw3::-webkit-scrollbar-track{background-color:var(--theme-ui-colors-scrollbar,hsl(285,5%,12%));}.css-1cyhw3::-webkit-scrollbar-thumb{background-color:var(--theme-ui-colors-muted,hsl(210,5%,40%));}</style><style data-emotion-css="1u4j0n9">.css-1u4j0n9{position:relative;margin-top:1.5rem;margin-bottom:1.5rem;}</style><style data-emotion-css="byi6om">.css-byi6om{box-sizing:border-box;margin:0;min-width:0;position:relative;margin-top:1.5rem;margin-bottom:1.5rem;}</style><div class="css-byi6om"><style data-emotion-css="c2yjs7">.css-c2yjs7{border-radius:0.25rem 0.25rem 0 0;background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));padding:0.5rem;padding-bottom:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style data-emotion-css="4aw43z">.css-4aw43z{box-sizing:border-box;margin:0;min-width:0;border-radius:0.25rem 0.25rem 0 0;background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));padding:0.5rem;padding-bottom:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-4aw43z"><style data-emotion-css="113kf6a">.css-113kf6a{position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(22,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><style data-emotion-css="6awz5m">.css-6awz5m{box-sizing:border-box;margin:0;min-width:0;position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(22,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><div class="css-6awz5m">text</div><style data-emotion-css="pbbfx5">.css-pbbfx5{box-sizing:border-box;margin:0;min-width:0;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:inline-block;text-align:center;line-height:inherit;-webkit-text-decoration:none;text-decoration:none;font-size:inherit;padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;color:var(--theme-ui-colors-white,#fff);background-color:var(--theme-ui-colors-primary,hsl(345,100%,69%));border:0;border-radius:4px;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;font-size:0.7rem;background-color:var(--theme-ui-colors-badgeBg,hsl(285,5%,17%));-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;color:var(--theme-ui-colors-text,hsl(210,38%,95%));border:1px solid var(--theme-ui-colors-badgeBorder,hsl(285,5%,12%));border-radius:large;margin-left:auto;}.css-pbbfx5:hover,.css-pbbfx5:focus{background-color:var(--theme-ui-colors-badgeBgHover,hsl(285,5%,20%));}</style><button class="css-pbbfx5">Copy</button></div><style data-emotion-css="1w2u0m3">.css-1w2u0m3{padding:1rem;color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));border-radius:0.25rem;overflow-x:auto;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;padding:1rem;padding-top:0.5rem;margin-top:0;font-size:0.875rem;color:var(--theme-ui-colors-text,hsl(210,38%,95%));background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));overflow-x:auto;border-radius:0 0 0.25rem 0.25rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}.css-1w2u0m3 .comment,.css-1w2u0m3 .prolog,.css-1w2u0m3 .doctype,.css-1w2u0m3 .cdata{color:var(--theme-ui-colors-code7,#999988);font-style:italic;}.css-1w2u0m3 .namespace{opacity:0.7;}.css-1w2u0m3 .string,.css-1w2u0m3 .attr-value,.css-1w2u0m3 .punctuation,.css-1w2u0m3 .tag.script-punctuation,.css-1w2u0m3 .tag.attr-value.punctuation{color:var(--theme-ui-colors-code3,#ffd866);}.css-1w2u0m3 .entity,.css-1w2u0m3 .url,.css-1w2u0m3 .symbol,.css-1w2u0m3 .number,.css-1w2u0m3 .boolean,.css-1w2u0m3 .constant,.css-1w2u0m3 .property,.css-1w2u0m3 .regex,.css-1w2u0m3 .inserted,.css-1w2u0m3 .attr-value,.css-1w2u0m3 .tag.attr-value{color:var(--theme-ui-colors-text,hsl(210,38%,95%));}.css-1w2u0m3 .function,.css-1w2u0m3 .tag.function,.css-1w2u0m3 .deleted,.css-1w2u0m3 .variable,.css-1w2u0m3 .unit{color:var(--theme-ui-colors-code3,#ffd866);}.css-1w2u0m3 .function-variable{color:var(--theme-ui-colors-code6,#ab9df2);}.css-1w2u0m3 .tag,.css-1w2u0m3 .keyword,.css-1w2u0m3 .selector,.css-1w2u0m3 .attr-name,.css-1w2u0m3 .tag.attr-name{color:var(--theme-ui-colors-code5,#78dce8);}.css-1w2u0m3 .symbol,.css-1w2u0m3 .tag.punctuation{color:var(--theme-ui-colors-code7,#999988);}.css-1w2u0m3 .property,.css-1w2u0m3 .number{color:var(--theme-ui-colors-code6,#ab9df2);}.css-1w2u0m3 .rule,.css-1w2u0m3 .class-name,.css-1w2u0m3 .keyword.module,.css-1w2u0m3 .operator,.css-1w2u0m3 .tag{color:var(--theme-ui-colors-code1,hsl(345,100%,69%));}.css-1w2u0m3 .function,.css-1w2u0m3 .tag.function{color:var(--theme-ui-colors-code4,#a9dc76);}.css-1w2u0m3::-webkit-scrollbar{width:0.5rem;height:0.5rem;}.css-1w2u0m3::-webkit-scrollbar:hover{width:1rem;height:1rem;}.css-1w2u0m3::-webkit-scrollbar-track{background-color:var(--theme-ui-colors-scrollbar,hsl(285,5%,12%));}.css-1w2u0m3::-webkit-scrollbar-thumb{background-color:var(--theme-ui-colors-muted,hsl(210,5%,40%));}</style><pre class="language-text prism-code language-text css-1w2u0m3"><div class="token-line"><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><span class="token plain css-1baulvz">|--------|    |---------|    |---------|</span></div><div class="token-line"><span class="token plain css-1baulvz">|   3    | -&gt; | 2 Media | -&gt; |    1    |</span></div><div class="token-line"><span class="token plain css-1baulvz">| Copies |    |  Types  |    | Offsite |</span></div><div class="token-line"><span class="token plain css-1baulvz">|--------|    |---------|    |---------|</span></div></pre></div><p class="css-mfqae4">Achieving this backup strategy isn&#x27;t particularly difficult to do. A simple setup with this scheme could
be done with the following:</p><ul class="css-0"><li class="css-0">Primary data source (a laptop)</li><li class="css-0">A backup of the primary data source (a usb or external hard drive)</li><li class="css-0">A backup of the primary data source (a cloud backup)</li></ul><p class="css-mfqae4">With a setup like this, we end up with 3 copies of our data. We have at least 2 different types of media
(external hard drive and cloud storage), and one copy offsite (in the cloud). Therefore, we should have
fairly decent data redundancy.</p><h2 id="my-strategy" class="css-1sv7zxb">My strategy<a class="slug css-zoqt8o" href="#my-strategy"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">Based on the above and for my own purposes, I decided a viable backup process would involve the following:</p><ul class="css-0"><li class="css-0">Primary data source (laptops, desktops, phones, etc)</li><li class="css-0">A backup of the primary data to the NAS at home</li><li class="css-0">A backup of the NAS at home to a similar NAS offsite</li><li class="css-0">A backup of the NAS to the cloud</li></ul><p class="css-mfqae4">This scheme gives me a decent amount of flexibility and options for backing up my data, as well as generally
follows the 3-2-1 rule I described above. The main benefit of using this method is that each device I backup only
needs to keep track of a single backup target. That backup target then can be easily backed up to a secondary target
without the primary device needing to have any intervention. In the event the backup target is destroyed, it can be
replaced by the secondary target, and the secondary target replaced by a new device with all of the data replicated
to it. This ensures that in the event a device is lost, data is still well protected and devices can be replaced easily
with minimal downtime since we can promote devices to take each other&#x27;s place as needed.</p><h2 id="technologies" class="css-1sv7zxb">Technologies<a class="slug css-zoqt8o" href="#technologies"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">Primary data sources would be backed up using the following:</p><ul class="css-0"><li class="css-0"><style data-emotion-css="bxllfp">.css-bxllfp{-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;}.css-bxllfp:link,.css-bxllfp:visited{font-weight:700;color:var(--theme-ui-colors-text,hsl(210,38%,95%));-webkit-text-decoration:none;text-decoration:none;border-bottom:2px solid;border-bottom-color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}.css-bxllfp:hover,.css-bxllfp:focus{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><a href="https://www.borgbackup.org/" class="css-bxllfp">Borg</a> (via <a href="https://torsion.org/borgmatic/" class="css-bxllfp">Borgmatic</a> or <a href="https://vorta.borgbase.com/" class="css-bxllfp">Vorta</a>) for linux/macos hosts using</li><li class="css-0"><a href="https://rsync.samba.org/" class="css-bxllfp">rsync</a> for random hosts/data that don&#x27;t need dedupe and other Borg niceties</li><li class="css-0"><a href="https://www.samba.org/" class="css-bxllfp">samba</a> for macOS/Windows</li></ul><p class="css-mfqae4">The backup targets would be machines running <em class="css-0">Ubuntu Server 22.04 LTS</em>. All backup data would be stored in <em class="css-0">ZFS</em>,
which would ultimately make our desired scheme trivial to implement. They would have the following configuration:</p><ul class="css-0"><li class="css-0">32gb of ram</li><li class="css-0">8 core cpu, 3.5ghz base clock</li><li class="css-0">4 18tb HDDs using ZFS and in a single zpool</li><li class="css-0">A small HDD for OS install</li></ul><p class="css-mfqae4">For the base OS, the default installation parameters were chosen. Regarding the actual backup storage devices (the 18tb HDDs),
a zpool was created that consisted of two mirrored vdevs, with each mirror containing 2 disks. This strategy provides decent
redundancy in the case that a disk fails (we can lose up to one disk in each vdev), while also allowing us to grow the pool in
the future. If the pool is ever running low on data, we can easily add another vdev of 2 disks to increase the capacity. This
method does result in our storage pool having capacity of half the total disk space we have available (18tb * 2 vdevs = 36tb).</p><p class="css-mfqae4">Over using zraid, this option gives us fantastic performance, good scalability, and ease of management.</p><p class="css-mfqae4">The choice of ZFS simplifies our NAS backups, as we can utilize the ability of ZFS to send and receive snapshots to send backups
of our data. This is a huge benefit as it simplifies the backup process tremendously. Our systems are large enough that the overhead
of running ZFS itself should be neglible, and we can reap huge benefits in our ability to easily replicate our data. Snapshots don&#x27;t
cost us anything to use (a huge benefit due to the fact that ZFS is CoW, copy-on-write), so we can feel safe knowing that we can use them.</p><h2 id="backup-setup" class="css-1sv7zxb">Backup Setup<a class="slug css-zoqt8o" href="#backup-setup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><style data-emotion-css="148dqy5">.css-148dqy5{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:1.875rem;}</style><style data-emotion-css="132t1t5">.css-132t1t5{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:1.875rem;}.css-132t1t5:hover .slug{opacity:0.6;}</style><h3 id="zfs-setup" class="css-132t1t5">ZFS Setup<a class="slug css-zoqt8o" href="#zfs-setup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h3><p class="css-mfqae4">The setup process for each NAS was pretty much the same and can be summarized by the following:</p><ol class="css-0"><li class="css-0"><p class="css-mfqae4">Install ZFS on Linux and setup the zpool named <style data-emotion-css="d08lk6">.css-d08lk6{background-color:var(--theme-ui-colors-background,hsl(285,5%,17%));padding:0.1em 0.2em;font-size:1em;border-radius:0.25rem;font-weight:inherit;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}</style><code class="css-d08lk6">backup</code>:</p><div class="css-byi6om"><div class="css-4aw43z"><style data-emotion-css="1u2sznp">.css-1u2sznp{position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(198,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><style data-emotion-css="1u9bgso">.css-1u9bgso{box-sizing:border-box;margin:0;min-width:0;position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(198,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Install ZoL</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token function css-1baulvz">apt-get</span><span class="token plain css-1baulvz"> update </span><span class="token operator css-1baulvz">&amp;&amp;</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">apt-get</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">install</span><span class="token plain css-1baulvz"> zfsutils-linux -y</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Get the list of devices by their ids to ensure</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># they are found correctly when the pool is imported:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token function css-1baulvz">ls</span><span class="token plain css-1baulvz"> /dev/disk/by-id/*</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Create the mirrored pool with the first vdev</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zpool create -o </span><span class="token assign-left variable css-1baulvz">ashift</span><span class="token operator css-1baulvz">=</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">ashift</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"> backup mirror </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  /dev/disk/by-id/</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  /dev/disk/by-id/</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Add another vdev to the pool (can be done as many times as we want, expanding the pool)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zpool </span><span class="token function css-1baulvz">add</span><span class="token plain css-1baulvz"> -o </span><span class="token assign-left variable css-1baulvz">ashift</span><span class="token operator css-1baulvz">=</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">ashift</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"> backup mirror </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  /dev/disk/by-id/</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  /dev/disk/by-id/</span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Enable compression for the pool (if desired)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs </span><span class="token builtin class-name css-1baulvz">set</span><span class="token plain css-1baulvz"> </span><span class="token assign-left variable css-1baulvz">compression</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">on backup</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Disable mounting for the pool (if desired)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs </span><span class="token builtin class-name css-1baulvz">set</span><span class="token plain css-1baulvz"> </span><span class="token assign-left variable css-1baulvz">canmount</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">off backup</span></div></pre></div><style data-emotion-css="1a7xx5g">.css-1a7xx5g{border-left:4px solid;border-color:var(--theme-ui-colors-muted,hsl(210,5%,40%));font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-style:italic;padding-left:1rem;margin-top:1.5rem;margin-bottom:1.5rem;margin-left:0;margin-right:0;}</style><blockquote class="css-1a7xx5g"><p class="css-mfqae4"><strong class="css-0"><em class="css-0">NOTE:</em></strong> I decided to use <code class="css-d08lk6">compression=on</code>, but you can tune this to your own preferences.
I also decided not to encrypt the entire zpool, so I could control this per-dataset (and therefore),
have different encryption keys per dataset. You should modify these snippets how you want (including)
changing variables to what you want them to be.</p></blockquote></li><li class="css-0"><p class="css-mfqae4">Setup the different datasets you want:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Create an encrypted dataset for borg</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  backup/borg</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Create an encrypted dataset for misc</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  backup/misc</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Setup a dataset for samba with some settings we need</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># We disable access times, inherit acls, disable unneeded</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># permissions, and set extended attributes to be stored more</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># optimally for performance. I also set a quota for samba</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># and the descendant data sets to 5T.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># The quota can also be changed later or switched to `refquota`</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># which does not include snapshot sizes.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm</span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt</span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase</span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">atime</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">off </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">dnodesize</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">auto </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">aclinherit</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passthrough </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">acltype</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">posixacl </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">xattr</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">sa </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">exec</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">off </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">devices</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">off </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">setuid</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">off </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">canmount</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">on </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">quota</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">5T </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  backup/samba</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Setup a dataset for windows and inherit the samba configs</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># (but set a different encryption key)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase backup/samba/windows</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Setup a dataset for macos and inherit the samba configs</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># (but set a different encryption key)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase backup/samba/macos</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Setup a dataset for public use and inherit the samba configs</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># (but set a different encryption key)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs create -o </span><span class="token assign-left variable css-1baulvz">encryption</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">aes-256-gcm </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keylocation</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">prompt </span><span class="token punctuation css-1baulvz">\</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  -o </span><span class="token assign-left variable css-1baulvz">keyformat</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">passphrase backup/samba/public</span></div></pre></div></li></ol><p class="css-mfqae4">After running the above, we can see the status of our pool:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Get the zpool status</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zpool status</span></div></pre></div><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">pool: backup</span></div><div class="token-line"><span class="token plain css-1baulvz"> state: ONLINE</span></div><div class="token-line"><span class="token plain css-1baulvz">  scan: scrub repaired 0B </span><span class="token keyword css-1baulvz">in</span><span class="token plain css-1baulvz"> 08:40:45 with </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"> errors on Sun Mar </span><span class="token number css-1baulvz">10</span><span class="token plain css-1baulvz"> 09:04:46 </span><span class="token number css-1baulvz">2024</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">config:</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz">        NAME                                  STATE     READ WRITE CKSUM</span></div><div class="token-line"><span class="token plain css-1baulvz">        backup                                ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">          mirror-0                            ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">            </span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz">                  ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">            </span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz">                  ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">          mirror-1                            ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">            </span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz">                  ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">            </span><span class="token punctuation css-1baulvz">{</span><span class="token plain css-1baulvz">device_id_here</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz">                  ONLINE       </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">     </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz">errors: No known data errors</span></div></pre></div><p class="css-mfqae4">And get our datasets:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># List our datasets</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs list -t filesystem</span></div></pre></div><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">NAME                   USED  AVAIL     REFER  MOUNTPOINT</span></div><div class="token-line"><span class="token plain css-1baulvz">backup                   0K  </span><span class="token number css-1baulvz">34</span><span class="token plain css-1baulvz">.0T        0K  /backup</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/borg              0K  </span><span class="token number css-1baulvz">34</span><span class="token plain css-1baulvz">.0T        0K  /backup/borg</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/misc              0K  </span><span class="token number css-1baulvz">34</span><span class="token plain css-1baulvz">.0T        0K  /backup/misc</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba             0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/macos       0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/macos</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/public      0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/public</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/windows     0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/windows</span></div></pre></div><h3 id="software-setup" class="css-132t1t5">Software Setup<a class="slug css-zoqt8o" href="#software-setup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h3><p class="css-mfqae4">For software that truly isn&#x27;t necessary to run on the host, I&#x27;ll be utilizing
<a href="https://docs.docker.com/engine/" class="css-bxllfp">Docker</a> and <a href="https://docs.docker.com/compose/" class="css-bxllfp">Docker Compose</a>
for deployment and software management. I&#x27;ve decided to do this is it makes it easy for me to
manage configuration state and track changes to the deployment strategy as code. Also, this ensures
that any software I run on this host will continue to function even if I move to a different host OS
(for example, if I decide to swith to Debian or Fedora). You could also use <a href="https://podman.io/" class="css-bxllfp">Podman</a>
if you&#x27;d like for this step.</p><blockquote class="css-1a7xx5g"><p class="css-mfqae4"><strong class="css-0"><em class="css-0">NOTE:</em></strong> The below settings have a user and password set with <code class="css-d08lk6">${USER}</code> and <code class="css-d08lk6">${PASSWORD}</code> respectively.
This is not an environment variable. You need to modify these snippets yourself in order to set it up how you want it.</p></blockquote><style data-emotion-css="95xwxg">.css-95xwxg{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:1.5rem;}</style><style data-emotion-css="1mkyfg6">.css-1mkyfg6{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:1rem;font-size:1.5rem;}.css-1mkyfg6:hover .slug{opacity:0.6;}</style><h4 id="ssh-setup-borg-and-rsync" class="css-1mkyfg6">SSH Setup (borg and rsync)<a class="slug css-zoqt8o" href="#ssh-setup-borg-and-rsync"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h4><style data-emotion-css="ulo14s">.css-ulo14s{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:0.5rem;font-size:1.25rem;}</style><style data-emotion-css="12hqtth">.css-12hqtth{font-family:inherit;font-weight:400;line-height:1.25;margin-top:1.5rem;margin-bottom:0.5rem;font-size:1.25rem;}.css-12hqtth:hover .slug{opacity:0.6;}</style><h5 id="borg" class="css-12hqtth">Borg<a class="slug css-zoqt8o" href="#borg"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h5><p class="css-mfqae4">I utilize the <a href="https://hub.docker.com/r/nold360/borgserver" class="css-bxllfp"><code class="css-d08lk6">nold360/borgserver</code></a> image. The image is easy to
configure, and assumes I have the local directories <code class="css-d08lk6">./sshkeys</code> and <code class="css-d08lk6">./data</code> to store each piece of data
accordingly. User ssh keys are placed in <code class="css-d08lk6">./sshkeys/clients/</code>, each being the name of the borg repository that key
will have access to. It&#x27;s important to note that this file can only contain a single key. Setting <code class="css-d08lk6">BORG_APPEND_ONLY</code>
disables data deletion until the <code class="css-d08lk6">BORG_ADMIN</code> runs a prune operation. Here&#x27;s the compose file:</p><div class="css-byi6om"><div class="css-4aw43z"><style data-emotion-css="w59r6r">.css-w59r6r{position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(111,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><style data-emotion-css="1gum8k6">.css-1gum8k6{box-sizing:border-box;margin:0;min-width:0;position:absolute;top:0;left:1rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;background-color:hsla(111,40%,60%,0.5);text-transform:uppercase;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;line-height:1;border-radius:0 0 0.2rem 0.2rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;height:auto;}</style><div class="css-1gum8k6">yml</div><button class="css-pbbfx5">Copy</button></div><pre class="language-yml prism-code language-yml css-1w2u0m3"><div class="token-line"><span class="token key atrule css-1baulvz">version</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&#x27;3.8&#x27;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token key atrule css-1baulvz">services</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token key atrule css-1baulvz">server</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">image</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> nold360/borgserver</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">bookworm</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">volumes</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./sshkeys</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/sshkeys</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./data</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/backup</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">ports</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;22222:22&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">environment</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token key atrule css-1baulvz">BORG_SERVE_ARGS</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;--progress --debug&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token key atrule css-1baulvz">BORG_APPEND_ONLY</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;yes&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token comment css-1baulvz"># BORG_ADMIN: &quot;${USER}&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">restart</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> always</span></div></pre></div><p class="css-mfqae4">I keep the compose file at the root of the <code class="css-d08lk6">/backup/borg</code> dataset. This allows my compose setup to also be included
as part of snapshots.</p><h5 id="rsync" class="css-12hqtth">rsync<a class="slug css-zoqt8o" href="#rsync"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h5><p class="css-mfqae4">rsync access is done directly using the host in this situation. I previously used a docker image for this, but decided
it was unnecessary.</p><h4 id="samba-setup" class="css-1mkyfg6">Samba Setup<a class="slug css-zoqt8o" href="#samba-setup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h4><p class="css-mfqae4">I utilize the <a href="https://github.com/vremenar/samba/pkgs/container/samba" class="css-bxllfp"><code class="css-d08lk6">ghcr.io/vremenar/samba</code></a> image,
which is based on <a href="https://hub.docker.com/r/dperson/samba" class="css-bxllfp"><code class="css-d08lk6">dperson/samba</code></a> but updates the samba and
alpine versions. I then utilize a custom samba config for setting Time Machine shares, and the default
configuration provided by the image. Here&#x27;s the compose file:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1gum8k6">yml</div><button class="css-pbbfx5">Copy</button></div><pre class="language-yml prism-code language-yml css-1w2u0m3"><div class="token-line"><span class="token key atrule css-1baulvz">version</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&#x27;3.8&#x27;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token key atrule css-1baulvz">services</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token key atrule css-1baulvz">server</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">image</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> ghcr.io/vremenar/samba</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">latest</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">volumes</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./samba.conf</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/samba.conf</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./macos</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/macos</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./public</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/public</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> ./windows</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/windows</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">ports</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;139:139&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;445:445&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">command</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">|</span><span class="token scalar string css-1baulvz"></span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -p -n</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -g &quot;log level = 2&quot;</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -I /samba.conf</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -u &quot;${USER};${PASSWORD}&quot;</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -s &quot;public;/public;yes;yes;yes;all;none;${USER}&quot;</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -s &quot;windows-shared;/windows/shared;yes;no;no;all&quot;</span></div><div class="token-line"><span class="token scalar string css-1baulvz">      -s &quot;macos-shared;/macos/shared;yes;no;no;all&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">restart</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> always</span></div></pre></div><p class="css-mfqae4">This configuration broadcasts 3 shares by default:</p><ol class="css-0"><li class="css-0">public, mapped to the <code class="css-d08lk6">/public</code> volume. It is browseable (discoverable),
is read only, and has guest access enabled. All users have access to view
the share, and there are no admins on the share. The only user that can
write files to the share is ${USER}. I&#x27;ll utilize this share for storing
public assets that I might need on my network (installation scripts, shared
apps, etc).</li><li class="css-0">windows-shared, mapped to <code class="css-d08lk6">/windows/shared</code>. This is a shared mount for
windows machines on the network. All users have access to it and it is
browseable.</li><li class="css-0">macos-shared, mapped to <code class="css-d08lk6">/macos/shared</code>. This is a shared mount for
macOS machines on the network. All users have access to it and it is
browseable.</li></ol><p class="css-mfqae4">There is nothing preventing mac or windows machines from accessing the shared mounts,
but this allows me to set attributes per-share if needed in the future
(such as shadow files and versions in windows). Also, more separation is not a
bad thing in this situation.</p><p class="css-mfqae4">For Time Machine, a custom samba.conf is utilized. the contents are as follows:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-6awz5m">text</div><button class="css-pbbfx5">Copy</button></div><pre class="language-text prism-code language-text css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">[${USER}-timemachine]</span></div><div class="token-line"><span class="token plain css-1baulvz">    comment = ${USER}&#x27;s Time Machine</span></div><div class="token-line"><span class="token plain css-1baulvz">    path = /macos/timemachine/${USER}</span></div><div class="token-line"><span class="token plain css-1baulvz">    browseable = no</span></div><div class="token-line"><span class="token plain css-1baulvz">    writeable = yes</span></div><div class="token-line"><span class="token plain css-1baulvz">    create mask = 0600</span></div><div class="token-line"><span class="token plain css-1baulvz">    directory mask = 0700</span></div><div class="token-line"><span class="token plain css-1baulvz">    spotlight = yes</span></div><div class="token-line"><span class="token plain css-1baulvz">    vfs objects = catia fruit streams_xattr</span></div><div class="token-line"><span class="token plain css-1baulvz">    fruit:aapl = yes</span></div><div class="token-line"><span class="token plain css-1baulvz">    fruit:time machine = yes</span></div><div class="token-line"><span class="token plain css-1baulvz">    valid users = ${USER}</span></div></pre></div><p class="css-mfqae4">Here we create a non-browseable share that has a single valid user. We also set the proper <code class="css-d08lk6">vfs objects</code>
settings and mark the share as Time Machine specific.</p><p class="css-mfqae4">I keep the compose file and config at the root of the <code class="css-d08lk6">/backup/samba</code> dataset. This allows my compose setup to also be included
as part of snapshots like the above.</p><p class="css-mfqae4">It&#x27;s important that you set the right permissions on the path you use within the extra <code class="css-d08lk6">samba.conf</code> (like in my situation).
You need to make sure the directory exists in your zfs dataset and has the right permissions so the samba container can
access it. For me, I ran the following:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Create the path on the ZFS dataset</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token function css-1baulvz">mkdir</span><span class="token plain css-1baulvz"> -p macos/timemachine/</span><span class="token variable css-1baulvz">${</span><span class="token variable environment constant css-1baulvz">USER</span><span class="token variable css-1baulvz">}</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Set permissions on the path to the smbuser and smb group from within the container</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># If you deploy it with a different method than me, you can use `id smbuser` to get</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># the correct uid/gid to use.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token function css-1baulvz">chown</span><span class="token plain css-1baulvz"> -R </span><span class="token number css-1baulvz">100</span><span class="token plain css-1baulvz">:101 macos/timemachine/</span><span class="token variable css-1baulvz">${</span><span class="token variable environment constant css-1baulvz">USER</span><span class="token variable css-1baulvz">}</span></div></pre></div><h2 id="replication-setup" class="css-1sv7zxb">Replication Setup<a class="slug css-zoqt8o" href="#replication-setup"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">Now that our NAS and different methods of getting data onto our NAS are setup, it&#x27;s time to setup replication to ensure
our NAS is backed up to a secondary location (the last part of our 3-2-1 solution). To do this, we&#x27;ll make use of ZFS
Snapshots, which is an easy way to take a snapshot of the current state of a dataset.</p><h3 id="zfs-snapshots" class="css-132t1t5">ZFS Snapshots<a class="slug css-zoqt8o" href="#zfs-snapshots"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h3><p class="css-mfqae4">Because ZFS is a CoW (copy-on-write) filesystem, snapshots don&#x27;t utilize any extra data and are immutable.
Snapshots can also be sent over a pipe (like with SSH) so they are portable. If desired, snapshots could
even be written to file. The other powerful utility of snapshots is that we can utilize them incrementally,
meaning we only send the changes to a dataset each backup cycle instead of the entire dataset.</p><p class="css-mfqae4">In order to take a snapshot, we utilize the <code class="css-d08lk6">zfs snapshot</code> command like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Take a snapshot of the main backup/samba dataset. The snapshot name is `initial`.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Because we use `-r`, this will also take a snapshot of all child datasets</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs snapshot -r backup/samba@initial</span></div></pre></div><p class="css-mfqae4">After running this command, we can show our snapshots with the following command:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># List all items from our zpool that come from backup/samba</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs list -t all -r backup/samba</span></div></pre></div><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">NAME                           USED  AVAIL     REFER  MOUNTPOINT</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba                     0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba@initial             0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/macos               0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/macos</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/macos@initial       0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/public              0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/public</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/public@initial      0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/windows             0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/windows</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/windows@initial     0K      -        0K  -</span></div></pre></div><p class="css-mfqae4">If we have another zfs machine we can send our snapshots to, we can run something like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Send the snapshots verbosely (-v) under `backup/samba` with the name `initial` recursively (-R)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># raw (-w), meaning as the encrypted data on disk. Pipe it through `pv` (pipeviewer to see transfer stats)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># and receive it on the server named `backup1`, allowing for interruption (-s), also with verbose info (-v)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># into the dataset named backup/samba.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs send -vRw backup/samba@initial </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">pv</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">ssh</span><span class="token plain css-1baulvz"> backup1 zfs recv -s -v backup/samba</span></div></pre></div><p class="css-mfqae4">On <code class="css-d08lk6">backup1</code>, we can see the snapshots and datasets like above:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">NAME                           USED  AVAIL     REFER  MOUNTPOINT</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba                     0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba@initial             0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/macos               0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/macos</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/macos@initial       0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/public              0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/public</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/public@initial      0K      -        0K  -</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/windows             0K  </span><span class="token number css-1baulvz">5</span><span class="token plain css-1baulvz">.00T        0K  /backup/samba/windows</span></div><div class="token-line"><span class="token plain css-1baulvz">backup/samba/windows@initial     0K      -        0K  -</span></div></pre></div><p class="css-mfqae4">The difference is, our datasets are not mounted in each mountpoint. You can see this by running:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Use df to see mounted filesystems</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token function css-1baulvz">df</span><span class="token plain css-1baulvz"> -h</span></div></pre></div><p class="css-mfqae4">In order to mount them, we do the following:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Mount all zfs mounts, and load the encryption keys</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs </span><span class="token function css-1baulvz">mount</span><span class="token plain css-1baulvz"> -al</span></div></pre></div><p class="css-mfqae4">For each filesystem, you will be asked for the passphrase that was used when the dataset was created.
This means we can send our encrypted filesystems anywhere (even to a file) and not be worried that our data
can be accessed. This is great for all kinds of reasons and opens up many possibilities. For example, a friend
and I can be each other&#x27;s offsite backup without being worried of them accessing my data. You can also save snapshots
to a file and store them on a blob storage backend or some storage box in the cloud.</p><p class="css-mfqae4">Filesystems can be unmounted using the following:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Unmount all zfs mounts, and unload the encryption keys</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs unmount -au</span></div></pre></div><p class="css-mfqae4">If we take another snapshot on <code class="css-d08lk6">backup0</code> and want to send it to <code class="css-d08lk6">backup1</code> incrementally, we can do it like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Take the snapshot</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs snapshot -r backup/samba@next</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Send snapshots between `initial` and `next` to `backup1`</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs send -vRwI backup/samba@initial backup/samba@next </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">pv</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">ssh</span><span class="token plain css-1baulvz"> backup1 zfs recv -s -v backup/samba</span></div></pre></div><h3 id="reconciliation" class="css-132t1t5">Reconciliation<a class="slug css-zoqt8o" href="#reconciliation"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h3><p class="css-mfqae4">If you see an error like this:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">send from @initial to backup/samba@next estimated size is </span><span class="token number css-1baulvz">77</span><span class="token plain css-1baulvz">.1K</span></div><div class="token-line"><span class="token plain css-1baulvz">send from @initial to backup/samba/public@next estimated size is </span><span class="token number css-1baulvz">43</span><span class="token plain css-1baulvz">.1K</span></div><div class="token-line"><span class="token plain css-1baulvz">send from @initial to backup/samba/macos@next estimated size is 112K</span></div><div class="token-line"><span class="token plain css-1baulvz">send from @initial to backup/samba/windows@next estimated size is </span><span class="token number css-1baulvz">40</span><span class="token plain css-1baulvz">.6K</span></div><div class="token-line"><span class="token plain css-1baulvz">total estimated size is 273K</span></div><div class="token-line"><span class="token plain css-1baulvz">receiving incremental stream of backup/samba@next into backup/samba@next</span></div><div class="token-line"><span class="token plain css-1baulvz">cannot receive incremental stream: destination backup/samba has been modified</span></div><div class="token-line"><span class="token plain css-1baulvz">since </span><span class="token function css-1baulvz">most</span><span class="token plain css-1baulvz"> recent snapshot</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token number css-1baulvz">86</span><span class="token plain css-1baulvz">.8KiB </span><span class="token number css-1baulvz">0</span><span class="token plain css-1baulvz">:00:00 </span><span class="token punctuation css-1baulvz">[</span><span class="token plain css-1baulvz"> 164KiB/s</span><span class="token punctuation css-1baulvz">]</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">[</span><span class="token operator css-1baulvz">&lt;=</span><span class="token operator css-1baulvz">&gt;</span><span class="token plain css-1baulvz">                                             </span><span class="token punctuation css-1baulvz">]</span></div></pre></div><p class="css-mfqae4">You need to reset the state of the receiving pool to the snapshot that was previously sent.
You can do that like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># List snapshots (-t) of the dataset (and children, -r), without headers (-H), and roll it back</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># This assumes there is only one snapshot per dataset on the machine, your mileage may vary.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs list -Hrt snapshot backup/samba </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">awk</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&#x27;{print $1}&#x27;</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">xargs</span><span class="token plain css-1baulvz"> -I</span><span class="token punctuation css-1baulvz">{</span><span class="token punctuation css-1baulvz">}</span><span class="token plain css-1baulvz"> zfs rollback </span><span class="token punctuation css-1baulvz">{</span><span class="token punctuation css-1baulvz">}</span></div></pre></div><p class="css-mfqae4">You can avoid this by setting each dataset on the remote backup side to readonly like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">zfs </span><span class="token builtin class-name css-1baulvz">set</span><span class="token plain css-1baulvz"> </span><span class="token assign-left variable css-1baulvz">readonly</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">on backup/samba</span></div></pre></div><h3 id="automated-backups-with-send-and-receive" class="css-132t1t5">Automated backups with send and receive<a class="slug css-zoqt8o" href="#automated-backups-with-send-and-receive"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h3><p class="css-mfqae4">Now that we have all of the tools we need to make backups a reality, let&#x27;s go ahead and set up an automated way to handle backups.
We will be using <code class="css-d08lk6">backup0</code> as our main NAS and <code class="css-d08lk6">backup1</code> as our secondary NAS</p><p class="css-mfqae4">First, let&#x27;s create a user on our <code class="css-d08lk6">backup1</code> for us to receive ssh connections to:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Use adduser to create a user, we can use the defaults for everything.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">adduser zfsbackup</span></div></pre></div><p class="css-mfqae4">Next, let&#x27;s create a SSH key on <code class="css-d08lk6">backup0</code> which will be used to access the user:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Generate an ed25519 key. Save it to a file like `~/.ssh/id_ed25519_zfsbackup`</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># You may choose to have a key per dataset as we can limit which dataset the ssh</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># process has access to with `authorized_keys`.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">ssh-keygen -t ed25519</span></div></pre></div><p class="css-mfqae4">On <code class="css-d08lk6">backup1</code>, allow <code class="css-d08lk6">zfsbackup</code> user access to the pool (or specific datasets) we want with only create, mount, and receive permissions:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Limit our blast radius by only allowing zfsbackup to create, mount and receive files. Don&#x27;t allow it to destroy or delete data.</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs allow -u zfsbackup create,mount,receive backup</span></div></pre></div><p class="css-mfqae4">Also on <code class="css-d08lk6">backup1</code>, let&#x27;s setup the <code class="css-d08lk6">authorized_keys</code> file in <code class="css-d08lk6">/home/zfsbackup/.ssh/authorized_keys</code> with the following:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-6awz5m">text</div><button class="css-pbbfx5">Copy</button></div><pre class="language-text prism-code language-text css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">command=&quot;/opt/backup/ssh.sh backup/samba&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-ed25519 .... root@backup0</span></div></pre></div><p class="css-mfqae4">This file only allows the zfsbackup user to run a single command (<code class="css-d08lk6">/opt/backup/ssh.sh backup/samba ...</code>), which is a wrapper around <code class="css-d08lk6">zfs recv</code> and
also allows us to get the latest snapshot on the host, which is how we will only incrementally send the snapshots that <code class="css-d08lk6">backup1</code> doesn&#x27;t know
about. This allows us to limit the types of commands the ssh user can run.</p><p class="css-mfqae4">Next, the contents of the shell script at <code class="css-d08lk6">/opt/backup/ssh.sh</code> is as follows:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token shebang important css-1baulvz">#!/bin/bash</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Set the dataset name the user can access</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable css-1baulvz">DATASET_NAME</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${1</span><span class="token string variable operator css-1baulvz">:?</span><span class="token string variable css-1baulvz">Dataset not provided}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Go through the exec command that was sent via ssh</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">case</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$SSH_ORIGINAL_COMMAND</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">in</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  recv</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token comment css-1baulvz"># Receive the snapshots into the dataset</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    zfs recv -v </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${DATASET_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  latest</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token comment css-1baulvz"># List the most recent snapshot in the dataset</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    zfs list -t snapshot -o name -s creation -H </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${DATASET_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">tail</span><span class="token plain css-1baulvz"> -n </span><span class="token number css-1baulvz">1</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  *</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;unknown command </span><span class="token string variable css-1baulvz">$DATASET_NAME</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">exit</span><span class="token plain css-1baulvz"> </span><span class="token number css-1baulvz">1</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">esac</span></div></pre></div><p class="css-mfqae4">This prevents the user from making queries about any datasets other than the one pinned in the <code class="css-d08lk6">authorized_keys</code> file. This can be easily changed
to allow the user access to any of the datasets in a pool like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token shebang important css-1baulvz">#!/bin/bash</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Set the dataset name/parent the user has access to</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable css-1baulvz">DATASET_NAME</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${1</span><span class="token string variable operator css-1baulvz">:?</span><span class="token string variable css-1baulvz">Dataset or pool not provided}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Set the original command as args</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token builtin class-name css-1baulvz">set</span><span class="token plain css-1baulvz"> -- </span><span class="token variable css-1baulvz">$SSH_ORIGINAL_COMMAND</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Pull the dataset the user wanted to manage</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable css-1baulvz">REAL_DATASET</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${2</span><span class="token string variable operator css-1baulvz">:-</span><span class="token string variable css-1baulvz">$DATASET_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Check if the dataset is a child of the allowed parent</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">if</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">[</span><span class="token punctuation css-1baulvz">[</span><span class="token plain css-1baulvz"> </span><span class="token variable css-1baulvz">$REAL_DATASET</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">!=</span><span class="token plain css-1baulvz"> </span><span class="token variable css-1baulvz">$DATASET_NAME</span><span class="token plain css-1baulvz">* </span><span class="token punctuation css-1baulvz">]</span><span class="token punctuation css-1baulvz">]</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">then</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;no permissions for dataset </span><span class="token string variable css-1baulvz">$REAL_DATASET</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token builtin class-name css-1baulvz">exit</span><span class="token plain css-1baulvz"> </span><span class="token number css-1baulvz">1</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">fi</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Check the command the user wants to run</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">case</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$1</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">in</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  recv</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token comment css-1baulvz"># Receive the snapshots</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    zfs recv -v </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${REAL_DATASET}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  latest</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token comment css-1baulvz"># List the latest snapshot for the dataset</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    zfs list -t snapshot -o name -s creation -H </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${REAL_DATASET}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">tail</span><span class="token plain css-1baulvz"> -n </span><span class="token number css-1baulvz">1</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  *</span><span class="token punctuation css-1baulvz">)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;unknown command </span><span class="token string variable css-1baulvz">$1</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">exit</span><span class="token plain css-1baulvz"> </span><span class="token number css-1baulvz">1</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token punctuation css-1baulvz">;</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">esac</span></div></pre></div><p class="css-mfqae4">Put this script somewhere owned by <code class="css-d08lk6">root</code> but accessible to other users (and executable). I chose <code class="css-d08lk6">/opt/backup/ssh.sh</code>. The directory
and file have permissions <code class="css-d08lk6">0755</code> set on it.</p><blockquote class="css-1a7xx5g"><p class="css-mfqae4"><strong class="css-0"><em class="css-0">NOTE:</em></strong> Use these scripts at your own risk. I have not configured them to handle every possible corner case.</p></blockquote><p class="css-mfqae4">We can test that our script is working properly by querying for the latest snapshot:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token function css-1baulvz">ssh</span><span class="token plain css-1baulvz"> -i .ssh/id_ed25519_zfsbackup zfsbackup@backup1 latest</span></div></pre></div><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token plain css-1baulvz">backup/samba@next</span></div></pre></div><p class="css-mfqae4">Now let&#x27;s setup our cronjob to actually send our updates. On <code class="css-d08lk6">backup0</code>, we create a file at <code class="css-d08lk6">/etc/cron.daily/backup</code> with the same
permissions <code class="css-d08lk6">0755</code> set. I chose to use the run-parts cron setup, but you can choose to do this however you&#x27;d like.</p><p class="css-mfqae4">The content of the file looks like this:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token shebang important css-1baulvz">#!/bin/bash</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Set our path</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable environment constant css-1baulvz">PATH</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Safe bash defaults</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token builtin class-name css-1baulvz">set</span><span class="token plain css-1baulvz"> -euo pipefail</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Create our snapshot name based on todays iso date</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable css-1baulvz">SNAPSHOT_NAME</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$(</span><span class="token string variable function css-1baulvz">date</span><span class="token string variable css-1baulvz"> +</span><span class="token string variable string css-1baulvz">&quot;%Y-%m-%dT%H:%M:%S-%Z&quot;</span><span class="token string variable css-1baulvz">)</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># Iterate through a list of datasets, could just as easily loop through the output of zfs list -t filesystem</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">for</span><span class="token plain css-1baulvz"> </span><span class="token for-or-select variable css-1baulvz">DATASET</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">in</span><span class="token plain css-1baulvz"> samba</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">do</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token comment css-1baulvz"># Get the local latest snapshot fpr diffing</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token assign-left variable css-1baulvz">LOCAL_LATEST</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$(</span><span class="token string variable css-1baulvz">zfs list -t snapshot -o name -s creation -H </span><span class="token string variable string css-1baulvz">&quot;backup/</span><span class="token string variable string variable css-1baulvz">${DATASET}</span><span class="token string variable string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz"> </span><span class="token string variable operator css-1baulvz">|</span><span class="token string variable css-1baulvz"> </span><span class="token string variable function css-1baulvz">tail</span><span class="token string variable css-1baulvz"> -n </span><span class="token string variable number css-1baulvz">1</span><span class="token string variable css-1baulvz">)</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token comment css-1baulvz"># Check if the local latest snapshot is different than the current state of the filesystem (or if FORCE_BACKUP is set)</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token keyword css-1baulvz">if</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">[</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$(</span><span class="token string variable css-1baulvz">zfs </span><span class="token string variable function css-1baulvz">diff</span><span class="token string variable css-1baulvz"> </span><span class="token string variable string css-1baulvz">&quot;</span><span class="token string variable string variable css-1baulvz">${LOCAL_LATEST}</span><span class="token string variable string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz"> </span><span class="token string variable operator css-1baulvz">|</span><span class="token string variable css-1baulvz"> </span><span class="token string variable function css-1baulvz">wc</span><span class="token string variable css-1baulvz"> -l</span><span class="token string variable css-1baulvz">)</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;0&quot;</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">]</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">&amp;&amp;</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">[</span><span class="token plain css-1baulvz"> -z </span><span class="token variable css-1baulvz">${FORCE_BACKUP</span><span class="token variable operator css-1baulvz">:-</span><span class="token variable css-1baulvz">}</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">]</span><span class="token punctuation css-1baulvz">;</span><span class="token plain css-1baulvz"> </span><span class="token keyword css-1baulvz">then</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;Skipping backup of backup/</span><span class="token string variable css-1baulvz">${DATASET}</span><span class="token string css-1baulvz"> as no files have changed.&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token builtin class-name css-1baulvz">continue</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token keyword css-1baulvz">fi</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token comment css-1baulvz"># Take the snapshot</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;Taking snapshot backup/</span><span class="token string variable css-1baulvz">${DATASET}</span><span class="token string css-1baulvz">@</span><span class="token string variable css-1baulvz">${SNAPSHOT_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  zfs snapshot -r </span><span class="token string css-1baulvz">&quot;backup/</span><span class="token string variable css-1baulvz">${DATASET}</span><span class="token string css-1baulvz">@</span><span class="token string variable css-1baulvz">${SNAPSHOT_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token comment css-1baulvz"># Get the latest snapshot on the remote side</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token assign-left variable css-1baulvz">LATEST_SNAPSHOT</span><span class="token operator css-1baulvz">=</span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">$(</span><span class="token string variable function css-1baulvz">ssh</span><span class="token string variable css-1baulvz"> -i </span><span class="token string variable string css-1baulvz">&quot;/root/.ssh/id_ed25519_zfsbackup&quot;</span><span class="token string variable css-1baulvz"> zfsbackup@backup1 latest</span><span class="token string variable css-1baulvz">)</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token comment css-1baulvz"># Send incremental snapshot between the latest on the remote and the one we just took</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token builtin class-name css-1baulvz">echo</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;Sending incremental snapshots between </span><span class="token string variable css-1baulvz">${LATEST_SNAPSHOT}</span><span class="token string css-1baulvz"> backup/</span><span class="token string variable css-1baulvz">${DATASET}</span><span class="token string css-1baulvz">@</span><span class="token string variable css-1baulvz">${SNAPSHOT_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  zfs send -RwI </span><span class="token string css-1baulvz">&quot;</span><span class="token string variable css-1baulvz">${LATEST_SNAPSHOT}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;backup/</span><span class="token string variable css-1baulvz">${DATASET}</span><span class="token string css-1baulvz">@</span><span class="token string variable css-1baulvz">${SNAPSHOT_NAME}</span><span class="token string css-1baulvz">&quot;</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">pv</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">ssh</span><span class="token plain css-1baulvz"> -i </span><span class="token string css-1baulvz">&quot;/root/.ssh/id_ed25519_zfsbackup&quot;</span><span class="token plain css-1baulvz"> zfsbackup@backup1 recv</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token keyword css-1baulvz">done</span></div></pre></div><p class="css-mfqae4">You can test the cron backup by using:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Run the script</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">/etc/cron.daily/backup</span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token comment css-1baulvz"># If the snapshot is new, force send a backup</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token assign-left variable css-1baulvz">FORCE_BACKUP</span><span class="token operator css-1baulvz">=</span><span class="token plain css-1baulvz">true /etc/cron.daily/backup</span></div></pre></div><p class="css-mfqae4">You can also test it using run-parts:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Trigger run-parts for the daily component</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">run-parts /etc/cron.daily</span></div></pre></div><h4 id="cloud-backups" class="css-1mkyfg6">Cloud Backups<a class="slug css-zoqt8o" href="#cloud-backups"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h4><p class="css-mfqae4">Use <a href="https://www.rsync.net/products/zfsintro.html" class="css-bxllfp">rsync.net</a> and send and receive as if you built a second NAS like above!</p><p class="css-mfqae4">Or, send snapshots as a blob to <a href="https://www.backblaze.com/cloud-storage" class="css-bxllfp">BackBlaze B2</a>. For example:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Send a snapshot incrementally and upload it to b2</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">zfs send -vRwI backup/samba@initial backup/samba@next </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">pv</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> b2 upload-unbound-stream zfs-backups - backup-samba-initial-backup-samba-next</span></div></pre></div><p class="css-mfqae4">And receive the snapshot like so:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1u9bgso">bash</div><button class="css-pbbfx5">Copy</button></div><pre class="language-bash prism-code language-bash css-1w2u0m3"><div class="token-line"><span class="token comment css-1baulvz"># Receive a snapshot from b2</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">b2 download-file-by-name zfs-backups backup-samba-initial-backup-samba-next - </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> </span><span class="token function css-1baulvz">pv</span><span class="token plain css-1baulvz"> </span><span class="token operator css-1baulvz">|</span><span class="token plain css-1baulvz"> zfs recv -s -v backup/samba</span></div></pre></div><h2 id="monitoring" class="css-1sv7zxb">Monitoring<a class="slug css-zoqt8o" href="#monitoring"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">For monitoring my systems, I use <a href="https://prometheus.io/" class="css-bxllfp">Prometheus</a> and <a href="https://grafana.com/" class="css-bxllfp">Grafana</a> exclusively.
I won&#x27;t go into setting up those two services, but I use the following docker-compose.yml for these deployments:</p><div class="css-byi6om"><div class="css-4aw43z"><div class="css-1gum8k6">yml</div><button class="css-pbbfx5">Copy</button></div><pre class="language-yml prism-code language-yml css-1w2u0m3"><div class="token-line"><span class="token key atrule css-1baulvz">version</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token string css-1baulvz">&quot;3.8&quot;</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">
</span></div><div class="token-line"><span class="token plain css-1baulvz"></span><span class="token key atrule css-1baulvz">services</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token key atrule css-1baulvz">node-exporter</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">image</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> quay.io/prometheus/node</span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz">exporter</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">latest</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">restart</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> always</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">volumes</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/host</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span><span class="token punctuation css-1baulvz">,</span><span class="token plain css-1baulvz">rslave</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">network_mode</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> host</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">pid</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> host</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">command</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> </span><span class="token punctuation css-1baulvz">-</span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz">path.rootfs=/host</span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token key atrule css-1baulvz">cadvisor</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">image</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> gcr.io/cadvisor/cadvisor</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">latest</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">restart</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> always</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">volumes</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/rootfs</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /var/run</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/var/run</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /sys</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/sys</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /var/lib/docker/</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/var/lib/docker</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /dev/disk/</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">/dev/disk</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">ro</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">ports</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> 9080</span><span class="token punctuation css-1baulvz">:</span><span class="token number css-1baulvz">8080</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">privileged</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token boolean important css-1baulvz">true</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">devices</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> /dev/kmsg</span></div><div class="token-line"><span class="token plain css-1baulvz">  </span><span class="token key atrule css-1baulvz">smartctl-exporter</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">image</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> prometheuscommunity/smartctl</span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz">exporter</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz">latest</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">restart</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> always</span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">ports</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">      </span><span class="token punctuation css-1baulvz">-</span><span class="token plain css-1baulvz"> 9633</span><span class="token punctuation css-1baulvz">:</span><span class="token number css-1baulvz">9633</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">privileged</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> </span><span class="token boolean important css-1baulvz">true</span><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain css-1baulvz">    </span><span class="token key atrule css-1baulvz">user</span><span class="token punctuation css-1baulvz">:</span><span class="token plain css-1baulvz"> root</span></div></pre></div><p class="css-mfqae4">This compose file lives in <code class="css-d08lk6">/backup/misc/monitoring</code>, so it is also retained as part of my backups.</p><p class="css-mfqae4">Here are some graphs from Grafana:</p><p class="css-mfqae4"><img src="/images/zfs-nas/smart-1.png" alt="smart status 1" class="css-0"/>
<img src="/images/zfs-nas/smart-2.png" alt="smart status 2" class="css-0"/>
<img src="/images/zfs-nas/smart-3.png" alt="smart status 3" class="css-0"/></p><p class="css-mfqae4"><img src="/images/zfs-nas/docker-1.png" alt="docker status 1" class="css-0"/>
<img src="/images/zfs-nas/docker-2.png" alt="docker status 2" class="css-0"/></p><h2 id="networking" class="css-1sv7zxb">Networking<a class="slug css-zoqt8o" href="#networking"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">I utilize <a href="https://www.zerotier.com/" class="css-bxllfp">ZeroTier</a> to maintain a secure network for my devices to communicate on. You can use any method you may choose.</p><h2 id="acknowledgements" class="css-1sv7zxb">Acknowledgements<a class="slug css-zoqt8o" href="#acknowledgements"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="0.8em" width="0.8em" xmlns="http://www.w3.org/2000/svg"><path d="M12.971 352h32.394C67.172 454.735 181.944 512 288 512c106.229 0 220.853-57.38 242.635-160h32.394c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0l-67.029 67.029c-7.56 7.56-2.206 20.485 8.485 20.485h35.146c-20.29 54.317-84.963 86.588-144.117 94.015V256h52c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12h-52v-5.47c37.281-13.178 63.995-48.725 64-90.518C384.005 43.772 341.605.738 289.37.01 235.723-.739 192 42.525 192 96c0 41.798 26.716 77.35 64 90.53V192h-52c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h52v190.015c-58.936-7.399-123.82-39.679-144.117-94.015h35.146c10.691 0 16.045-12.926 8.485-20.485l-67.029-67.029c-4.686-4.686-12.284-4.686-16.971 0L4.485 331.515C-3.074 339.074 2.28 352 12.971 352zM288 64c17.645 0 32 14.355 32 32s-14.355 32-32 32-32-14.355-32-32 14.355-32 32-32z"></path></svg></a></h2><p class="css-mfqae4">There are tools available that can help with setting up syncing and replicating ZFS datasets.
(see <a href="https://github.com/jimsalterjrs/sanoid" class="css-bxllfp">Sanoid/Syncoid</a>). I&#x27;m a firm believer in knowing everything about your data,
which is why I chose to role things on my own. This guide is to serve as an aide when it comes to choosing what is best
for yourself and your data.</p><p class="css-mfqae4">If you have any questions or comments, feel free to shoot me an <a href="mailto:me@antoniomika.me" class="css-bxllfp">email</a> or message me on <a href="https://web.libera.chat/#pico.sh" class="css-bxllfp">IRC</a>. </p><style data-emotion-css="1reecjh">.css-1reecjh{box-sizing:border-box;margin:0;min-width:0;margin-top:2.5rem;padding-top:1.5rem;border-top:2px solid;border-top-color:var(--theme-ui-colors-background,hsl(285,5%,17%));}</style><div class="css-1reecjh"><div class="css-4cffwv"><a href="https://github.com/antoniomika/notes/tree/master/notes/zfs-nas.md" class="css-wts7qx">Edit this page</a></div><p><style data-emotion-css="mcqe72">.css-mcqe72{box-sizing:border-box;margin:0;min-width:0;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.7rem;opacity:0.7;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;}</style><div class="css-mcqe72">Date: <!-- -->2024-03-13</div></p></div></article></div></main><style data-emotion-css="8jmlm3">.css-8jmlm3{width:50%;position:fixed;top:0;right:0;left:0;bottom:0;overflow-x:hidden;overflow-y:auto;padding-top:1.5rem;padding-bottom:4rem;}@media screen and (min-width:40em){.css-8jmlm3{width:240px;right:auto;}}</style><style data-emotion-css="1myka1i">.css-1myka1i{box-sizing:border-box;margin:0;min-width:0;width:50%;position:fixed;top:0;right:0;left:0;bottom:0;overflow-x:hidden;overflow-y:auto;padding-top:1.5rem;padding-bottom:4rem;}@media screen and (min-width:40em){.css-1myka1i{width:240px;right:auto;}}</style><header class="css-1myka1i"><style data-emotion-css="xo0iyu">.css-xo0iyu{box-sizing:border-box;margin:0;min-width:0;padding-left:1rem;padding-right:1rem;margin-bottom:1rem;}</style><div class="css-xo0iyu"><style data-emotion-css="19p2wcd">.css-19p2wcd{box-sizing:border-box;margin:0;min-width:0;margin-bottom:1rem;}</style><div class="css-19p2wcd"><style data-emotion-css="16ecpcm">.css-16ecpcm{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;max-width:100%;display:block;}</style><img src="https://antoniomika.me/icon.jpg" class="css-16ecpcm"/></div><div class="css-19p2wcd"><style data-emotion-css="1tj03ch">.css-1tj03ch{color:var(--theme-ui-colors-text,hsl(210,38%,95%));line-height:1.375;font-weight:700;}</style><style data-emotion-css="1smtvtc">.css-1smtvtc{box-sizing:border-box;margin:0;min-width:0;color:var(--theme-ui-colors-text,hsl(210,38%,95%));line-height:1.375;font-weight:700;}</style><div class="css-1smtvtc">A personal blog and note taking site</div></div></div><style data-emotion-css="155za0w">.css-155za0w{list-style-type:none;}</style><style data-emotion-css="16d60vq">.css-16d60vq{box-sizing:border-box;margin:0;min-width:0;list-style-type:none;}</style><nav class="css-16d60vq"><style data-emotion-css="1lejymi">.css-1lejymi{text-transform:uppercase;}</style><style data-emotion-css="1ixsdi0">.css-1ixsdi0{box-sizing:border-box;margin:0;min-width:0;color:inherit;-webkit-text-decoration:none;text-decoration:none;font-weight:700;display:inline-block;padding-left:1rem;padding-right:1rem;padding-top:0.25rem;padding-bottom:0.25rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-weight:400;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.875rem;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;text-transform:uppercase;}.css-1ixsdi0:hover,.css-1ixsdi0:focus,.css-1ixsdi0.active{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}.css-1ixsdi0:hover,.css-1ixsdi0:focus{background-color:var(--theme-ui-colors-navHover,hsl(285,5%,13%));color:var(--theme-ui-colors-text,hsl(210,38%,95%));}</style><a class="css-1ixsdi0" href="/">All Notes</a><style data-emotion-css="bp6y7h">.css-bp6y7h{padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.25rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-transform:uppercase;font-size:0.875rem;}</style><style data-emotion-css="12w5a9y">.css-12w5a9y{box-sizing:border-box;margin:0;min-width:0;padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.25rem;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-transform:uppercase;font-size:0.875rem;}</style><div class="css-12w5a9y">Tags</div><style data-emotion-css="22fc79">.css-22fc79{box-sizing:border-box;margin:0;min-width:0;color:inherit;-webkit-text-decoration:none;text-decoration:none;font-weight:700;display:inline-block;padding-left:1rem;padding-right:1rem;padding-top:0.25rem;padding-bottom:0.25rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-weight:400;font-family:"IBM Plex Mono","JetBrains Mono","Fira Code","Input Mono",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.875rem;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;}.css-22fc79:hover,.css-22fc79:focus,.css-22fc79.active{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}.css-22fc79:hover,.css-22fc79:focus{background-color:var(--theme-ui-colors-navHover,hsl(285,5%,13%));color:var(--theme-ui-colors-text,hsl(210,38%,95%));}</style><a class="css-22fc79" href="/tag/blog"><style data-emotion-css="1lexr7c">.css-1lexr7c{box-sizing:border-box;margin:0;min-width:0;background-color:hsla(355,40%,60%,0.5);width:10px;height:10px;border-radius:50%;margin-right:0.5em;}</style><div class="css-1lexr7c"></div>blog</a></nav><style data-emotion-css="13s5gr5">.css-13s5gr5{position:fixed;left:0;width:50%;bottom:0;background-color:var(--theme-ui-colors-backgroundTransparent,hsla(285,5%,17%,0.72));padding-top:1rem;padding-bottom:1rem;}@media screen and (min-width:40em){.css-13s5gr5{width:240px;}}</style><style data-emotion-css="o7758">.css-o7758{box-sizing:border-box;margin:0;min-width:0;position:fixed;left:0;width:50%;bottom:0;background-color:var(--theme-ui-colors-backgroundTransparent,hsla(285,5%,17%,0.72));padding-top:1rem;padding-bottom:1rem;}@media screen and (min-width:40em){.css-o7758{width:240px;}}</style><div class="css-o7758"><style data-emotion-css="1rxgw8g">.css-1rxgw8g{color:var(--theme-ui-colors-text,hsl(210,38%,95%));z-index:11;padding:0;display:block;margin-left:auto;margin-right:auto;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;cursor:pointer;}.css-1rxgw8g:hover{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><style data-emotion-css="naqdmg">.css-naqdmg{box-sizing:border-box;margin:0;min-width:0;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:0.25rem;width:32px;height:32px;color:inherit;background-color:transparent;border:none;border-radius:4px;color:var(--theme-ui-colors-text,hsl(210,38%,95%));z-index:11;padding:0;display:block;margin-left:auto;margin-right:auto;-webkit-transition:all 200ms ease-in-out;transition:all 200ms ease-in-out;cursor:pointer;}.css-naqdmg:hover{color:var(--theme-ui-colors-primary,hsl(345,100%,69%));}</style><button aria-label="Toggle dark mode" class="css-naqdmg"><svg width="1.5rem" height="1.5rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M912.1 512c0 20-1.4 39.9-4 59.7.5-3.5 1-7.1 1.4-10.6-5.2 38.4-15.5 75.9-30.5 111.6 1.3-3.2 2.7-6.4 4-9.6-14.8 34.8-34 67.6-57.1 97.6l6.3-8.1c-23 29.7-49.8 56.4-79.5 79.5l8.1-6.3c-30 23.1-62.8 42.3-97.6 57.1 3.2-1.3 6.4-2.7 9.6-4-35.7 15-73.2 25.3-111.6 30.6 3.5-.5 7.1-1 10.6-1.4a450.3 450.3 0 0 1-119.4 0c3.5.5 7.1 1 10.6 1.4-38.5-5.2-76-15.5-111.7-30.5 3.2 1.3 6.4 2.7 9.6 4-34.8-14.8-67.6-34-97.6-57.1l8.1 6.3c-29.7-23-56.4-49.8-79.5-79.5l6.3 8.1c-23.1-30-42.3-62.8-57.1-97.6 1.3 3.2 2.7 6.4 4 9.6-15-35.7-25.3-73.2-30.6-111.6.5 3.5 1 7.1 1.4 10.6a450.3 450.3 0 0 1 0-119.4c-.5 3.5-1 7.1-1.4 10.6 5.3-38.4 15.5-75.9 30.6-111.6-1.3 3.2-2.7 6.4-4 9.6 14.8-34.8 34-67.6 57.1-97.6l-6.3 8.1c23-29.7 49.8-56.4 79.5-79.5l-8.1 6.3c30-23.1 62.8-42.3 97.6-57.1-3.2 1.3-6.4 2.7-9.6 4 35.7-15 73.2-25.3 111.6-30.6-3.5.5-7.1 1-10.6 1.4 39.6-5.3 79.8-5.3 119.4 0-3.5-.5-7.1-1-10.6-1.4 38.4 5.3 75.9 15.5 111.6 30.6-3.2-1.3-6.4-2.7-9.6-4 34.8 14.8 67.6 34 97.6 57.1l-8.1-6.3c29.7 23 56.4 49.8 79.5 79.5l-6.3-8.1c23.1 30 42.3 62.8 57.1 97.6-1.3-3.2-2.7-6.4-4-9.6 15 35.7 25.3 73.2 30.6 111.6-.5-3.5-1-7.1-1.4-10.6 2.7 19.7 4 39.6 4 59.6 0 20.9 18.4 41 40 40s40-17.6 40-40c-.1-49.6-7.6-99.8-22.9-146.9-14.8-45.6-36.2-89.4-64-128.5-14.6-20.5-30.6-40.3-48.1-58.5-17.6-18.2-36.8-34.5-56.9-49.9-38-29.1-80.5-51.4-125.3-67.9-46.3-17.1-95.9-26.1-145.2-28.1-49.8-2-100.5 4.1-148.5 17.7-46.1 13.1-90.9 33.3-131 59.7-39.7 26.1-76 57.8-106.2 94.4-16.1 19.5-31.1 40-44.1 61.7-13.2 21.9-24 45-33.7 68.6-18.8 45.7-29.2 94.3-33 143.4-3.8 49.7.7 100.4 12.5 148.9C57 673.3 75.9 718.9 100.8 760c24.6 40.5 55.3 78 90.8 109.5 35.7 31.7 75.7 58.7 119.2 78.4 23.5 10.6 47.5 19.9 72.3 26.8 25.4 7.1 51.3 11.5 77.4 14.5 50 5.8 100.9 2.8 150.2-7.3 47.3-9.6 93.5-27.2 135.6-50.7 41.2-23 79.4-52.6 112.1-86.7 32.8-34.3 61.2-73.7 82.3-116.3 21.7-43.6 37.5-90.2 44.9-138.4 4-25.8 6.5-51.7 6.5-77.8 0-20.9-18.4-41-40-40-21.7 1-39.9 17.6-40 40z"></path><path d="M512 187.7v648.6c-179.1 0-324-145.2-324-324.3s144.9-324.3 324-324.3z"></path><path d="M482 187.7v569c0 26.2-.6 52.4 0 78.6v1.1l30-30c-14.4 0-28.8-1-43.1-2.8 2.7.4 5.3.7 8 1.1-28.6-3.9-56.5-11.5-83.1-22.6l7.2 3c-15-6.4-29.5-13.9-43.4-22.4-6.7-4.1-13.3-8.5-19.7-13.1-1.6-1.2-3.2-2.3-4.8-3.5-.8-.6-2.1-1.2-2.6-2-.1-.1 6.4 5.1 3 2.3-3.2-2.6-6.5-5.2-9.6-7.9-12.1-10.3-23.5-21.5-34.1-33.5-2.6-3-5.1-6-7.6-9-1.1-1.4-2.2-2.7-3.3-4.1-.5-.7-1.1-1.4-1.6-2.1 6.1 7.7 2.9 3.7 1.5 1.9-4.9-6.5-9.5-13.1-13.8-20-9.9-15.4-18.4-31.7-25.5-48.5l3 7.2c-11.2-26.6-18.8-54.5-22.6-83.1.4 2.7.7 5.3 1.1 8-3.7-28.6-3.7-57.6 0-86.2-.4 2.7-.7 5.3-1.1 8 3.9-28.6 11.4-56.5 22.6-83.1l-3 7.2c6.4-15 13.8-29.6 22.4-43.5 4.1-6.7 8.5-13.3 13.1-19.7 1.1-1.6 2.3-3.2 3.5-4.8.5-.7 1.2-2.2 2-2.6.1-.1-5 6.4-2.3 3 2.6-3.3 5.2-6.5 7.9-9.7 10.3-12.2 21.5-23.6 33.4-34.1 3-2.6 5.9-5.1 9-7.6 1.4-1.1 2.7-2.2 4.1-3.3.7-.5 1.4-1.1 2.1-1.6-7.6 6.1-3.7 2.9-1.9 1.5 6.5-4.9 13.1-9.5 19.9-13.9 15.4-9.9 31.6-18.4 48.4-25.6l-7.2 3c26.6-11.2 54.5-18.8 83.1-22.6-2.7.4-5.3.7-8 1.1 14.3-1.9 28.7-2.8 43.1-2.8 15.7 0 30.7-13.8 30-30-.7-16.2-13.2-30-30-30-72.2.2-144.6 22.3-203.4 64.4-59.5 42.6-104.5 101.2-129.7 170-25.2 68.6-27.5 146.1-7.6 216.3C190.5 676.5 230.6 739.1 285 784c57.5 47.4 126.9 75.7 201.2 81.6 8.6.7 17.3 1 25.9 1 16.2 0 30-13.8 30-30v-64.5-155-187.5-162c0-26.2.5-52.4 0-78.6v-1.1c0-15.7-13.8-30.7-30-30-16.4.5-30.1 13-30.1 29.8z"></path></svg></button></div></header></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/zfs-nas/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-396860297e70ece2e141.js"],"app":["/app-c6ef5c2f96254335c1a0.js"],"component---node-modules-gatsby-theme-code-notes-src-pages-404-tsx":["/component---node-modules-gatsby-theme-code-notes-src-pages-404-tsx-302a9fe8a78274bbcffa.js"],"component---src-gatsby-theme-code-notes-templates-note-js":["/component---src-gatsby-theme-code-notes-templates-note-js-b0f61fea6533f3ee3656.js"],"component---src-gatsby-theme-code-notes-templates-notes-js":["/component---src-gatsby-theme-code-notes-templates-notes-js-608bb00094014405ff17.js"],"component---src-gatsby-theme-code-notes-templates-tag-page-js":["/component---src-gatsby-theme-code-notes-templates-tag-page-js-a8613c3228ddadd58b9e.js"]};/*]]>*/</script><script src="/polyfill-396860297e70ece2e141.js" nomodule=""></script><script src="/component---src-gatsby-theme-code-notes-templates-note-js-b0f61fea6533f3ee3656.js" async=""></script><script src="/commons-0b008caf945293618b83.js" async=""></script><script src="/app-c6ef5c2f96254335c1a0.js" async=""></script><script src="/1bfc9850-284bb63085f6cc17369b.js" async=""></script><script src="/framework-643cd9d57cfac08fd2c4.js" async=""></script><script src="/webpack-runtime-6c5d3617d53de854ad20.js" async=""></script></body></html>